#chatZone
  .left_content
    %h3 Pixie Chat
    %ul#chats
      = render :partial => 'shared/recent_chats'
    = text_field_tag :chat_body, nil, :placeholder => 'chat with your friends here'
    %button#send.button Send

  .users_wrapper
    .header Online Now
    %ul#active_users
      = render :partial => 'shared/active_users'

:coffeescript
  scrollToBottomLeft = (el) ->
    el.scrollTo
      left: '0%'
      top: '100%'

  $ ->
    setTimeout ->
      scrollToBottomLeft $('#chats')
    , 3000

    window.setInterval ->
      $.get('/chats/active_users', $.noop, "script")
      $.get('/chats/recent', $.noop, "script")

      $('#chats').scrollTo
        left: '0%'
        top: '100%'

    , 30000

    send = (field) ->
      if field.val()
        $.post '/chats',
          body: field.val()

        li = $("<li />")

        name = $ '<span />',
          class: "name"
          text: "#{current_user.display_name if current_user || "Anonymous"} :"

        time = $ '<span />',
          class: "time"
          text: " #{Time.zone.now.strftime('%I:%M%p')} "

        message = $ '<span />',
          class: "message"
          html: field.val()

        li.append(name, time, message)

        $('#chats').append(li)
        scrollToBottomLeft($('#chats'))

        field.val("")

    textBox = $('#send').prev()

    $("#chatZone").dropImageReader (file, event) ->

      if event.target.readyState == FileReader.DONE
        wrapper = $("<div />")
        img = $ "<img/>",
          alt: file.name
          src: event.target.result
          title: file.name

        img.appendTo(wrapper)

        $.post '/chats', body: wrapper.html(), ->
          scrollToBottomLeft $('body')
          scrollToBottomLeft $('#chats')

    $('#chatZone #chat_body').keypress (e) ->
      if e.keyCode == 13
        send(textBox)

    $('#send').click ->
      send(textBox)

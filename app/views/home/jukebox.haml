-# %iframe#player(type="text/html" width="1" height="1" frameborder="0")
#player

%label#now_playing Now Playing:
%label#next_up Next Up:
%input#song_input(placeholder="Enter artist/song")
%button#play Play
%button#next Next

:coffeescript
  loadPlayerAPI = (callback) ->
    # Load player api asynchronously.
    tag = document.createElement('script')
    tag.src = "http://www.youtube.com/player_api"
    firstScriptTag = document.getElementsByTagName('script')[0]
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag)
    done = false
    player = null

    window.onYouTubePlayerAPIReady = ->
      callback()

  loadPlayerAPI ->
    getSongs("Lady Gaga")

    $("#play").click ->
      getSongs($("#song_input").val())
      $("#song_input").val('')

    $("#next").click ->
      nextSong()

    $("#song_input").bind "keydown", "return", ->
      getSongs($("#song_input").val())
      $("#song_input").val('')

  entries = []
  currentIndex = -1

  getSongs = (terms) ->
    url = "http://gdata.youtube.com/feeds/api/videos/-/{http%3A%2F%2Fgdata.youtube.com%2Fschemas%2F2007%2Fcategories.cat}Music?alt=json&callback=?"

    $.getJSON url, {
      enablejsapi: 1
      q: terms
    }, (result) ->
      console.log result

      entries = processSearchResults(result.feed.entry)

      nextSong()

  processSearchResults = (results) ->
    results.map (result) ->
      id: result.id.$t.split('/').last()
      title: result.title.$t

  nextSong = () ->
    currentIndex += 1
    entry = entries[currentIndex]

    id = entry.id
    createPlayer(id)

    title = entry.title
    $("#now_playing").text("Now Playing: \#{title}")

    if nextTitle = entries[currentIndex + 1]?.title
      $("#next_up").text("Next Up: \#{nextTitle}")
    else
      $("#next_up").text("Next Up: ...")

  createPlayer = (id) ->
    srcUrl = "http://www.youtube.com/embed/\#{id}?autoplay=1"
    $("#player").attr("src", srcUrl)

  createPlayer = (id) ->
    $("#player").empty()

    window.player = new YT.Player 'player',
      width: 1
      height: 1
      playerVars:
        controls: 0
      videoId: id
      events:
        onReady: (event) ->
          event.target.playVideo()
        onStateChange: (event) ->
          if event.data == YT.PlayerState.ENDED
            nextSong()

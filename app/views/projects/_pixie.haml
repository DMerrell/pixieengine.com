#titleModal
  %p
    = label_tag :title
    = text_field_tag :title, "", {:title => 'title'}

  %button Save

:coffeescript
  $ ->
    window.createPixelEditor = (options) ->
      width = options.width
      height = options.height
      dataUrl = options.dataUrl
      title = options.title
      path = options.path
      tab = null

      $('<div />').pixie
        width: width
        height: height
        frames: 1
        initializer: (canvas) ->
          if dataUrl
            canvas.fromDataURL(dataUrl)

          promptForTitle = ->
            $('#titleModal button').unbind()

            $("#titleModal button").one 'click', ->
              title = $("#titleModal input").val()

              tab.find("a").text title

              $.modal.close()
              postImage()

            $("#titleModal").modal()

              onClose: () ->
                $('#titleModal button').unbind()
                $.modal.close()

          postImage = ->
            notify "Saving, please wait..."

            postData =
              'format': 'json',
              'contents_base64': canvas.toBase64()
              'path': path

            $.post '/projects/#{project.id}/save_file', postData, (data) ->
              $(".tool.button").last().removeAttr("disabled")

              if data.status == "error"
                notify data.message
                return

              notify("Saved!")

              trackPageview("/event/save_drawing")
              canvas.dirty(false)
            , "json"

          canvas.addAction
            name: "Save"
            icon: "/images/icons/database_save.png"
            perform: (canvas) ->
              $(".tool.button").last().attr("disabled", true)

              tab = $("#tabs ul li").eq($("#tabs").tabs('option', 'selected'));

              postImage()

            undoable: false

- @title = "Sprite Gallery"

.sprite_gallery
  %nav.left
    .info_component
      %h3.name
      %span.author
      .sprite_container
        =image_tag("")
      %p.description
      %a.button#load_sprite{ :target => "_blank" }
        %img{ :src => "/images/icons/picture_edit.png" }
        Edit image
      -if current_user
        %a.button#set_avatar
          %img{ :src => "/images/icons/status_online.png"}
          Set as avatar
      =link_to "#{image_tag "icons/cross.png"} Delete".html_safe, "#", :method => :delete, :class => "button delete"
    .tag_component
      %h3 Tags
      .tags
        - form_tag "/sprites/#{sprites[0].id}/add_tag" do
          = text_field_tag :tag
          = submit_tag "Add"
    .comment_component
      = display_comments sprites[0]
    .edit_component
      %h3 Edit
      - form_for sprites[0] do |form|
        = form.error_messages

        = form.label :title
        = form.text_field :title

        = form.label :description
        = form.text_area :description

        = form.submit

  %section
    .sprites
      = will_paginate sprites

      = render :partial => "index_sprite", :collection => sprites

      .tags
        - tags = Sprite.with_ids(sprites).tag_counts
        - tags.each do |tag|
          = tag_link tag

      - @meta_desc = tags.join(' ') + sprites.map(&:title).compact.join(' ')

#new_tag.template
  .tag{ 'data-sprite_id' => "${sprite_id}" }
    %a{ :href => "/sprites?tagged=${name}" } ${name}
    .remove X

:coffeescript
  $( ->
    select_sprite = (el) ->
      $('section .sprite_container').removeClass('selected')

      el.addClass('selected')

    $('section .sprite_container').mousedown ->
      el = $(this)

      select_sprite(el)

      sprite =
        id: el.data('id')
        name: el.data('name')
        description: el.data('description')
        img: el.data('original_url')

      author =
        id: el.data('author_id')
        name: el.data('author')

      tags = el.data('tags')

      update_info_component(sprite, author)
      update_tag_component(tags, sprite)
      update_comment_component()
      update_edit_component(sprite)

    $('.comment_component form').ajaxForm
      beforeSerialize: -> notify("Saving...")
      success: (data) -> notify("Complete")

    $('.edit_component form').ajaxForm
      beforeSerialize: -> notify("Saving...")
      success: (data) ->
        notify("Complete!")

        el = $('.sprites .sprite_container.selected')

        sprite =
          id: el.data('id')
          name: el.data('name')
          description: el.data('description')

        author =
          id: el.data('author_id')
          name: el.data('author')

        update_sprite_info(sprite)
        update_info_component(sprite, author)

    clear_tags = ->
      $('.tag_component .tag').remove()

    update_tag_component = (tags, sprite) ->
      clear_tags()

      $.each tags.split(" "), (i, tag) ->
        $('#new_tag').tmpl(
          sprite_id: sprite.id
          name: tag
        ).insertBefore('.tag_component form')

      $('.tag_component form').attr('action', '/sprites/' + sprite.id + '/add_tag')

    clear_comments = ->
      $('.comment_component .comment').remove()

    update_comment_component = ->
      clear_comments()

    update_info_component = (sprite, author) ->
      $('.info_component .name').text(sprite.name)
      if author.id
        $('.info_component .author').text("by ").append('<a href= "users/' + author.id + '"> ' + author.name + '</a>')
      else
        $('.info_component .author a').remove()
        $('.info_component .author').text("by " + author.name)

      $('.info_component .sprite_container img').attr('src', sprite.img)
      $('.info_component p.description').text(sprite.description)
      $('.info_component a.delete').attr('href', '/sprites/' + sprite.id)
      $('#load_sprite').attr('href', '/sprites/' + sprite.id + '/load')

    update_edit_component = (sprite) ->
      $('.edit_component form').attr
        action: 'sprites/' + sprite.id
        id: 'edit_sprite_' + sprite.id

      $('.edit_component #sprite_title').val(sprite.name)
      $('.edit_component #sprite_description').val(sprite.description)

    update_sprite_info = (sprite) ->
      $('section .sprite_container[data-id="' + sprite.id + '"]').attr
        'data-name': sprite.name = $('.edit_component #sprite_title').val()
        'data-description': sprite.description = $('.edit_component #sprite_description').val()

    $("#set_avatar").live "click", ->
      notify("Saving...")

      data =
        sprite_id: $('section .sprite_container.selected').data('id')

      $.post("/users/#{current_user.id}/set_avatar", data, -> notify("Avatar successfully changed."))

    $('section .sprite_container').first().mousedown()
  )

%style
  :sass
    @import util
    @import blueprint/buttons
    @import partials/base

    #fullscreen
      a
        color: #000

      .author, .pagination
        a
          color: #fff

    form
      input[type="text"]
        +box-sizing(content-box)

        color: #000
        background-color: #fff

      input[type="submit"]
        margin: 0

      label
        text-align: left

      textarea
        +bounds(150px, 50px)

        margin: 0

    section
      padding-left: 350px

      .sprites
        +border-radius(8px)
        +box-sizing(border-box)

        border: 1px solid $pixie_primary
        padding: 15px

      .sprite_container
        cursor: pointer

        &:hover
          background-color: $hover

        &.selected
          background-color: $pixie_primary

    .info_component
      .sprite_container
        +border-radius(8px)
        +bounds(96px)
        +contents-centered

        background-color: #fff
        display: block
        margin-bottom: 7px

    h3.name
      display: inline-block
      margin-right: 10px
      margin-bottom: 0

    .sprite_gallery
      +box-sizing(border-box)
      +user-select(none)

      height: 100%
      position: relative

      nav.left
        +border-radius(8px)

        background-color: $dark_highlight
        left: 0
        padding-left: 15px
        position: absolute
        top: 0
        width: 320px

    button, a.button
      +button-button
      +button-colors
      +button-hover-colors
      +button-active-colors
      +border-radius(4px)

      margin: 0
      padding-left: 3px
      padding-right: 3px

      &[disabled]
        color: #AAA
        cursor: default

        &:hover
          color: #AAA

    .pagination
      color: $pixie_primary
      margin-bottom: 5px

    body
      .sprite_container
        +border-radius(8px)
        +bounds(48px)
        +contents-centered

        background-color: white
        display: inline-block
        margin-right: 7px
        margin-bottom: 3px
